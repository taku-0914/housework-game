<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßº ÂÆ∂‰∫ã„Éù„Ç§„É≥„Éà„Ç≤„Éº„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 10px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .content {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .score-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .score-card.blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .score-card h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .score-card .points {
            font-size: 3rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .score-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .task-form {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .task-list {
            display: grid;
            gap: 15px;
        }

        .task-item {
            background: white;
            border: 2px solid #f1f3f4;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .task-points {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .task-details {
            font-size: 0.9rem;
            color: #666;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            margin: 0 5px;
        }

        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }

        .btn-small.delete {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-small.delete:hover {
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.4);
        }

        .task-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .edit-form {
            display: grid;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f1f3f4;
        }

        .edit-form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            align-items: end;
        }

        .edit-form input {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .edit-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .hidden {
            display: none;
        }

        .log-entry {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 10px 10px 0;
        }

        .log-date {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .log-task {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .log-user {
            color: #667eea;
            font-weight: 600;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #dc3545;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .content {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .score-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßº ÂÆ∂‰∫ã„Éù„Ç§„É≥„Éà„Ç≤„Éº„É†</h1>
            <p>Âã§ÂãôÂΩ¢ÊÖã„ÇÑ‰ΩìË™ø„Å´Âøú„Åò„Å¶„Éù„Ç§„É≥„Éà„ÇíË£úÊ≠£„Åó„ÄÅÈÄ±„ÉªÊúàÂçò‰Ωç„Åß„Çπ„Ç≥„Ç¢„ÇíÈõÜË®à„Åô„Çã„Ç¢„Éó„É™</p>
            <div style="margin-top: 10px;">
                <span class="status-indicator connected" id="statusIndicator"></span>
                <span id="statusText">APIÊé•Á∂ö‰∏≠...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</button>
            <button class="tab" onclick="showTab('log')">üìù ÂÆ∂‰∫ã„ÇíË®òÈå≤</button>
            <button class="tab" onclick="showTab('tasks')">üè† ÂÆ∂‰∫ã‰∏ÄË¶ß</button>
            <button class="tab" onclick="showTab('manage')">‚öôÔ∏è ÂÆ∂‰∫ãÁÆ°ÁêÜ</button>
            <button class="tab" onclick="showTab('history')">üìà Â±•Ê≠¥</button>
        </div>

        <!-- „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
        <div id="dashboard" class="content">
            <div class="score-cards">
                <div class="score-card">
                    <h3>üë© Â¶ª„ÅÆ„Éù„Ç§„É≥„Éà</h3>
                    <div class="points" id="wifePoints">-</div>
                    <div class="label">‰ªäÈÄ±„ÅÆÂêàË®à</div>
                </div>
                <div class="score-card blue">
                    <h3>üë® Â§´„ÅÆ„Éù„Ç§„É≥„Éà</h3>
                    <div class="points" id="husbandPoints">-</div>
                    <div class="label">‰ªäÈÄ±„ÅÆÂêàË®à</div>
                </div>
            </div>
            <button class="btn" onclick="loadScores()">üîÑ „Çπ„Ç≥„Ç¢„ÇíÊõ¥Êñ∞</button>
        </div>

        <!-- ÂÆ∂‰∫ã„ÇíË®òÈå≤ -->
        <div id="log" class="content hidden">
            <div class="task-form">
                <h2 style="margin-bottom: 20px;">‚ú® ÂÆ∂‰∫ã„ÇíË®òÈå≤„Åô„Çã</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskSelect">ÂÆ∂‰∫ã„ÅÆÁ®ÆÈ°û</label>
                        <select id="taskSelect">
                            <!-- API„Åã„ÇâÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userSelect">ÂÆüË°åËÄÖ</label>
                        <select id="userSelect">
                            <option value="wife">üë© Â¶ª</option>
                            <option value="husband">üë® Â§´</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workLoad">Âã§ÂãôË≤†Ëç∑ (1.0-2.0)</label>
                        <input type="number" id="workLoad" value="1.0" min="1.0" max="2.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="healthCondition">‰ΩìË™ø (0.5-1.0)</label>
                        <input type="number" id="healthCondition" value="1.0" min="0.5" max="1.0" step="0.1">
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn" onclick="logTask()" id="logButton">
                        üéØ ÂÆ∂‰∫ã„ÇíË®òÈå≤„Åô„Çã
                    </button>
                    <button class="btn" onclick="loadTasksForSelect()" style="background: #28a745;">
                        üîÑ ÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
                    </button>
                </div>
            </div>
        </div>

        <!-- ÂÆ∂‰∫ã‰∏ÄË¶ß -->
        <div id="tasks" class="content hidden">
            <h2 style="margin-bottom: 20px;">üè† ÂÆ∂‰∫ã‰∏ÄË¶ß</h2>
            
            <!-- Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ -->
            <input type="text" id="taskSearchBox" class="search-box" placeholder="üîç ÂÆ∂‰∫ãÂêç„ÇÑË™¨Êòé„ÅßÊ§úÁ¥¢..." onkeyup="filterTasks()">
            
            <div class="task-list" id="tasksList">
                <!-- ÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø -->
            </div>
            <button class="btn" onclick="loadTasks()">üîÑ ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞</button>
        </div>

        <!-- ÂÆ∂‰∫ãÁÆ°ÁêÜ -->
        <div id="manage" class="content hidden">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è ÂÆ∂‰∫ãÁÆ°ÁêÜ</h2>
            
            <!-- CSVÊ©üËÉΩ -->
            <div class="task-form">
                <h3 style="margin-bottom: 15px;">üì§ CSV „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éª„Ç§„É≥„Éù„Éº„Éà</h3>
                <div class="form-row">
                    <button class="btn" onclick="exportTasksCSV()">üì• CSV „Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <div class="form-group">
                        <label for="csvFile">CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</label>
                        <input type="file" id="csvFile" accept=".csv" onchange="handleCSVFile(event)">
                    </div>
                </div>
                <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                    CSV„Éï„Ç©„Éº„Éû„ÉÉ„Éà: name, base_points, description
                </p>
            </div>
            
            <div class="task-form">
                <h3 style="margin-bottom: 15px;">‚ûï Êñ∞„Åó„ÅÑÂÆ∂‰∫ã„ÇíËøΩÂä†</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newTaskName">ÂÆ∂‰∫ãÂêç</label>
                        <input type="text" id="newTaskName" placeholder="‰æã: „ÅäÈ¢®ÂëÇÊéÉÈô§">
                    </div>
                    <div class="form-group">
                        <label for="newTaskPoints">„Éù„Ç§„É≥„Éà</label>
                        <input type="number" id="newTaskPoints" min="1" max="100" placeholder="‰æã: 15">
                    </div>
                </div>
                <div class="form-group">
                    <label for="newTaskDescription">Ë™¨ÊòéÔºà‰ªªÊÑèÔºâ</label>
                    <input type="text" id="newTaskDescription" placeholder="‰æã: Êµ¥ÊßΩ„Å®„Çø„Ç§„É´„ÅÆÊéÉÈô§">
                </div>
                <button class="btn" onclick="addNewTask()">‚ûï ÂÆ∂‰∫ã„ÇíËøΩÂä†</button>
            </div>
        </div>

        <!-- Â±•Ê≠¥ -->
        <div id="history" class="content hidden">
            <h2 style="margin-bottom: 20px;">üìà ÂÆ∂‰∫ãÂ±•Ê≠¥</h2>
            <div id="historyList">
                <!-- ÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø -->
            </div>
            <button class="btn" onclick="loadHistory()">üîÑ Â±•Ê≠¥„ÇíÊõ¥Êñ∞</button>
        </div>
    </div>

    <div id="notification" class="notification">
        „ÉÜ„Çπ„ÉàÈÄöÁü•
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentTab = 'dashboard';
        let isConnected = false;

        // APIÊé•Á∂öÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                statusText.textContent = 'APIÊé•Á∂öÊ∏à„Åø';
            } else {
                indicator.className = 'status-indicator disconnected';
                statusText.textContent = 'APIÊé•Á∂ö„Ç®„É©„Éº';
            }
        }

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function showTab(tabName) {
            // „Åô„Åπ„Å¶„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
            document.getElementById(tabName).classList.remove('hidden');
            
            // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Çø„Éñ„Å´active„ÇØ„É©„Çπ„ÇíËøΩÂä†
            event.target.classList.add('active');
            
            currentTab = tabName;

            // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊôÇ„Å´„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            switch(tabName) {
                case 'dashboard':
                    loadScores();
                    break;
                case 'tasks':
                    loadTasks();
                    break;
                case 'log':
                    await loadTasksForSelect(); // ÂÆ∂‰∫ãË®òÈå≤„Çø„Éñ„ÇíÈñã„ÅÑ„ÅüÊôÇ„ÇÇÊõ¥Êñ∞
                    break;
                case 'history':
                    loadHistory();
                    break;
            }
        }

        // APIÈñ¢Êï∞Áæ§
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(endpoint, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                updateConnectionStatus(true);
                return await response.json();
            } catch (error) {
                console.error('APIÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº:', error);
                updateConnectionStatus(false);
                throw error;
            }
        }

        // „Çπ„Ç≥„Ç¢Ë™≠„ÅøËæº„Åø
        async function loadScores() {
            try {
                const scores = await apiCall('/scores/weekly');
                document.getElementById('wifePoints').textContent = scores.wife_points;
                document.getElementById('husbandPoints').textContent = scores.husband_points;
            } catch (error) {
                showNotification('„Çπ„Ç≥„Ç¢„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „Çø„Çπ„ÇØ‰∏ÄË¶ßË™≠„ÅøËæº„Åø
        async function loadTasks() {
            try {
                const response = await apiCall('/tasks');
                window.allTasks = response.tasks || []; // „Ç∞„É≠„Éº„Éê„É´„Å´‰øùÂ≠ò
                displayTasks(window.allTasks);
            } catch (error) {
                showNotification('„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „Çø„Çπ„ÇØ„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
        function displayTasks(tasks) {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';
            
            if (tasks && tasks.length > 0) {
                tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item';
                    taskItem.setAttribute('data-task-id', task.id);
                    taskItem.innerHTML = `
                        <div class="task-header">
                            <div class="task-name">${task.name}</div>
                            <div class="task-points">${task.base_points}pt</div>
                        </div>
                        <div class="task-details">
                            Ë™¨Êòé: ${task.description}
                        </div>
                        <div class="task-actions">
                            <button class="btn-small" onclick="toggleEditForm(${task.id})">‚úèÔ∏è Á∑®ÈõÜ</button>
                            <button class="btn-small delete" onclick="deleteTask(${task.id}, '${task.name}')">üóëÔ∏è ÂâäÈô§</button>
                        </div>
                        <div id="editForm${task.id}" class="edit-form hidden">
                            <div class="edit-form-row">
                                <input type="text" id="editName${task.id}" value="${task.name}" placeholder="ÂÆ∂‰∫ãÂêç">
                                <input type="number" id="editPoints${task.id}" value="${task.base_points}" min="1" max="100" placeholder="„Éù„Ç§„É≥„Éà">
                            </div>
                            <input type="text" id="editDescription${task.id}" value="${task.description}" placeholder="Ë™¨ÊòéÔºà‰ªªÊÑèÔºâ">
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-small" onclick="saveTask(${task.id})">üíæ ‰øùÂ≠ò</button>
                                <button class="btn-small" onclick="toggleEditForm(${task.id})">‚ùå „Ç≠„É£„É≥„Çª„É´</button>
                            </div>
                        </div>
                    `;
                    tasksList.appendChild(taskItem);
                });
            } else {
                tasksList.innerHTML = '<p style="text-align: center; color: #666;">ÂÆ∂‰∫ã„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
            }
        }

        // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„ÉºÊ©üËÉΩ
        function filterTasks() {
            const searchTerm = document.getElementById('taskSearchBox').value.toLowerCase();
            const allTasks = window.allTasks || [];
            
            if (searchTerm === '') {
                displayTasks(allTasks);
            } else {
                const filteredTasks = allTasks.filter(task => 
                    task.name.toLowerCase().includes(searchTerm) || 
                    task.description.toLowerCase().includes(searchTerm)
                );
                displayTasks(filteredTasks);
            }
        }

        // Á∑®ÈõÜ„Éï„Ç©„Éº„É†„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
        function toggleEditForm(taskId) {
            const editForm = document.getElementById(`editForm${taskId}`);
            editForm.classList.toggle('hidden');
        }

        // „Çø„Çπ„ÇØ„Çí‰øùÂ≠ò
        async function saveTask(taskId) {
            const name = document.getElementById(`editName${taskId}`).value.trim();
            const points = parseInt(document.getElementById(`editPoints${taskId}`).value);
            const description = document.getElementById(`editDescription${taskId}`).value.trim();

            if (!name || !points) {
                showNotification('ÂÆ∂‰∫ãÂêç„Å®„Éù„Ç§„É≥„Éà„ÅØÂøÖÈ†à„Åß„Åô', 'error');
                return;
            }

            try {
                const updatedTask = {
                    name: name,
                    base_points: points,
                    description: description
                };

                await apiCall(`/tasks/${taskId}`, 'PUT', updatedTask);
                showNotification('ÂÆ∂‰∫ã„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');

                // ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                loadTasks();
                // „Çø„Çπ„ÇØÈÅ∏ÊäûËÇ¢„ÇÇÊõ¥Êñ∞
                loadTasksForSelect();

            } catch (error) {
                showNotification('ÂÆ∂‰∫ã„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „Çø„Çπ„ÇØ„ÇíÂâäÈô§
        async function deleteTask(taskId, taskName) {
            if (!confirm(`„Äå${taskName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                return;
            }

            try {
                await apiCall(`/tasks/${taskId}`, 'DELETE');
                showNotification(`„Äå${taskName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);

                // ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                loadTasks();
                // „Çø„Çπ„ÇØÈÅ∏ÊäûËÇ¢„ÇÇÊõ¥Êñ∞
                loadTasksForSelect();

            } catch (error) {
                showNotification('ÂÆ∂‰∫ã„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // ÂÆ∂‰∫ãË®òÈå≤Áî®„ÅÆ„Çø„Çπ„ÇØÈÅ∏ÊäûËÇ¢„ÇíË™≠„ÅøËæº„Åø
        async function loadTasksForSelect() {
            try {
                const response = await apiCall('/tasks');
                const taskSelect = document.getElementById('taskSelect');
                taskSelect.innerHTML = '';
                
                if (response.tasks && response.tasks.length > 0) {
                    response.tasks.forEach(task => {
                        const option = document.createElement('option');
                        option.value = task.id;
                        option.textContent = `${task.name} (${task.base_points}pt)`;
                        taskSelect.appendChild(option);
                    });
                } else {
                    taskSelect.innerHTML = '<option value="">ÂÆ∂‰∫ã„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</option>';
                }
            } catch (error) {
                showNotification('„Çø„Çπ„ÇØÈÅ∏ÊäûËÇ¢„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // Êñ∞„Åó„ÅÑÂÆ∂‰∫ã„ÇíËøΩÂä†
        async function addNewTask() {
            const name = document.getElementById('newTaskName').value.trim();
            const points = parseInt(document.getElementById('newTaskPoints').value);
            const description = document.getElementById('newTaskDescription').value.trim();

            if (!name || !points) {
                showNotification('ÂÆ∂‰∫ãÂêç„Å®„Éù„Ç§„É≥„Éà„ÅØÂøÖÈ†à„Åß„Åô', 'error');
                return;
            }

            try {
                const newTask = {
                    name: name,
                    base_points: points,
                    description: description
                };

                await apiCall('/tasks', 'POST', newTask);
                showNotification('Êñ∞„Åó„ÅÑÂÆ∂‰∫ã„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ');

                // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
                document.getElementById('newTaskName').value = '';
                document.getElementById('newTaskPoints').value = '';
                document.getElementById('newTaskDescription').value = '';

                // ÂÖ®„Å¶„ÅÆÈñ¢ÈÄ£„Åô„ÇãË°®Á§∫„ÇíÊõ¥Êñ∞
                await loadTasks();              // ÂÆ∂‰∫ã‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                await loadTasksForSelect();     // ÂÆ∂‰∫ãË®òÈå≤„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞

            } catch (error) {
                showNotification('ÂÆ∂‰∫ã„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // ÂÆ∂‰∫ãË®òÈå≤
        async function logTask() {
            const button = document.getElementById('logButton');
            const originalText = button.innerHTML;
            
            try {
                // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
                button.disabled = true;
                button.innerHTML = 'Ë®òÈå≤‰∏≠...';
                
                const logData = {
                    task_id: parseInt(document.getElementById('taskSelect').value),
                    user_id: document.getElementById('userSelect').value,
                    load: parseFloat(document.getElementById('workLoad').value),
                    health: parseFloat(document.getElementById('healthCondition').value)
                };
                
                const result = await apiCall('/logs', 'POST', logData);
                
                showNotification(`${result.log.task_name} „ÇíË®òÈå≤„Åó„Åæ„Åó„ÅüÔºÅ+${result.log.points}pt`);
                
                // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                document.getElementById('workLoad').value = '1.0';
                document.getElementById('healthCondition').value = '1.0';
                
                // „Çπ„Ç≥„Ç¢„ÇíÊõ¥Êñ∞
                loadScores();
                
            } catch (error) {
                showNotification('ÂÆ∂‰∫ã„ÅÆË®òÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            } finally {
                // „Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Â±•Ê≠¥Ë™≠„ÅøËæº„Åø
        async function loadHistory() {
            try {
                const response = await apiCall('/logs');
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                if (response.logs && response.logs.length > 0) {
                    response.logs.forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry';
                        
                        const date = new Date(log.created_at);
                        const dateStr = `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà${date.getDate()}Êó• ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                        const userIcon = log.user_id === 'wife' ? 'üë© Â¶ª' : 'üë® Â§´';
                        
                        logEntry.innerHTML = `
                            <div class="log-date">${dateStr}</div>
                            <div class="log-task">${log.task_name} (+${log.points}pt)</div>
                            <div class="log-user">ÂÆüË°åËÄÖ: ${userIcon} (Âã§ÂãôË≤†Ëç∑: ${log.load}, ‰ΩìË™ø: ${log.health})</div>
                        `;
                        historyList.appendChild(logEntry);
                    });
                } else {
                    historyList.innerHTML = '<p style="text-align: center; color: #666;">„Åæ„Å†Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                }
            } catch (error) {
                showNotification('Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        async function exportTasksCSV() {
            try {
                const response = await fetch('/tasks/export');
                if (!response.ok) {
                    throw new Error('CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'housework_tasks.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„ÅüÔºÅ');
            } catch (error) {
                showNotification('CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // CSV„Éï„Ç°„Ç§„É´„ÅÆ„Ç§„É≥„Éù„Éº„Éà
        async function handleCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                const response = await fetch('/tasks/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/octet-stream',
                    },
                    body: arrayBuffer
                });

                const result = await response.json();

                if (result.error) {
                    showNotification(`„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº: ${result.error}`, 'error');
                } else {
                    let message = result.message;
                    if (result.errors && result.errors.length > 0) {
                        message += `\nË≠¶Âëä: ${result.errors.length}‰ª∂„ÅÆ„Ç®„É©„Éº„Åå„ÅÇ„Çä„Åæ„Åó„Åü`;
                        console.log('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„ÉºË©≥Á¥∞:', result.errors);
                    }
                    showNotification(message);

                    // ÂÖ®„Å¶„ÅÆÈñ¢ÈÄ£„Åô„ÇãË°®Á§∫„ÇíÊõ¥Êñ∞
                    await loadTasks();              // ÂÆ∂‰∫ã‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                    await loadTasksForSelect();     // ÂÆ∂‰∫ãË®òÈå≤„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
                }

                // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
                event.target.value = '';

            } catch (error) {
                showNotification('CSV„Éï„Ç°„Ç§„É´„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // ÈÄöÁü•Ë°®Á§∫
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÊúü„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            loadScores();
            loadTasksForSelect();
        });
    </script>
</body>
</html>
