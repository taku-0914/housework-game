<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¼ å®¶äº‹ãƒã‚¤ãƒ³ãƒˆã‚²ãƒ¼ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 10px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .content {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .score-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .score-card.blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .score-card h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .score-card .points {
            font-size: 3rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .score-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .task-form {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .task-list {
            display: grid;
            gap: 15px;
        }

        .task-item {
            background: white;
            border: 2px solid #f1f3f4;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .task-points {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .task-details {
            font-size: 0.9rem;
            color: #666;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            margin: 0 5px;
        }

        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }

        .btn-small.delete {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-small.delete:hover {
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.4);
        }

        .task-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .edit-form {
            display: grid;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f1f3f4;
        }

        .edit-form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            align-items: end;
        }

        .edit-form input {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .edit-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .hidden {
            display: none;
        }

        .log-entry {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 10px 10px 0;
        }

        .log-date {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .log-task {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .log-user {
            color: #667eea;
            font-weight: 600;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #dc3545;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .content {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .score-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§¼ å®¶äº‹ãƒã‚¤ãƒ³ãƒˆã‚²ãƒ¼ãƒ </h1>
            <p>å‹¤å‹™å½¢æ…‹ã‚„ä½“èª¿ã«å¿œã˜ã¦ãƒã‚¤ãƒ³ãƒˆã‚’è£œæ­£ã—ã€é€±ãƒ»æœˆå˜ä½ã§ã‚¹ã‚³ã‚¢ã‚’é›†è¨ˆã™ã‚‹ã‚¢ãƒ—ãƒª</p>
            <div style="margin-top: 10px;">
                <span class="status-indicator connected" id="statusIndicator"></span>
                <span id="statusText">APIæ¥ç¶šä¸­...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
            <button class="tab" onclick="showTab('log')">ğŸ“ å®¶äº‹ã‚’è¨˜éŒ²</button>
            <button class="tab" onclick="showTab('tasks')">ğŸ  å®¶äº‹ä¸€è¦§</button>
            <button class="tab" onclick="showTab('manage')">âš™ï¸ å®¶äº‹ç®¡ç†</button>
            <button class="tab" onclick="showTab('history')">ğŸ“ˆ å±¥æ­´</button>
        </div>

        <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
        <div id="dashboard" class="content">
            <div class="score-cards">
                <div class="score-card">
                    <h3>ğŸ‘© å¦»ã®ãƒã‚¤ãƒ³ãƒˆ</h3>
                    <div class="points" id="wifePoints">-</div>
                    <div class="label">ä»Šé€±ã®åˆè¨ˆ</div>
                </div>
                <div class="score-card blue">
                    <h3>ğŸ‘¨ å¤«ã®ãƒã‚¤ãƒ³ãƒˆ</h3>
                    <div class="points" id="husbandPoints">-</div>
                    <div class="label">ä»Šé€±ã®åˆè¨ˆ</div>
                </div>
            </div>
            <button class="btn" onclick="loadScores()">ğŸ”„ ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°</button>
        </div>

        <!-- å®¶äº‹ã‚’è¨˜éŒ² -->
        <div id="log" class="content hidden">
            <div class="task-form">
                <h2 style="margin-bottom: 20px;">âœ¨ å®¶äº‹ã‚’è¨˜éŒ²ã™ã‚‹</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskSelect">å®¶äº‹ã®ç¨®é¡</label>
                        <select id="taskSelect">
                            <!-- APIã‹ã‚‰å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userSelect">å®Ÿè¡Œè€…</label>
                        <select id="userSelect">
                            <option value="wife">ğŸ‘© å¦»</option>
                            <option value="husband">ğŸ‘¨ å¤«</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workLoad">å‹¤å‹™è² è· (1.0-2.0)</label>
                        <input type="number" id="workLoad" value="1.0" min="1.0" max="2.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="healthCondition">ä½“èª¿ (0.5-1.0)</label>
                        <input type="number" id="healthCondition" value="1.0" min="0.5" max="1.0" step="0.1">
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn" onclick="logTask()" id="logButton">
                        ğŸ¯ å®¶äº‹ã‚’è¨˜éŒ²ã™ã‚‹
                    </button>
                    <button class="btn" onclick="loadTasksForSelect()" style="background: #28a745;">
                        ğŸ”„ é¸æŠè‚¢ã‚’æ›´æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- å®¶äº‹ä¸€è¦§ -->
        <div id="tasks" class="content hidden">
            <h2 style="margin-bottom: 20px;">ğŸ  å®¶äº‹ä¸€è¦§</h2>
            
            <!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
            <input type="text" id="taskSearchBox" class="search-box" placeholder="ğŸ” å®¶äº‹åã‚„èª¬æ˜ã§æ¤œç´¢..." onkeyup="filterTasks()">
            
            <div class="task-list" id="tasksList">
                <!-- å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
            </div>
            <button class="btn" onclick="loadTasks()">ğŸ”„ ä¸€è¦§ã‚’æ›´æ–°</button>
        </div>

        <!-- å®¶äº‹ç®¡ç† -->
        <div id="manage" class="content hidden">
            <h2 style="margin-bottom: 20px;">âš™ï¸ å®¶äº‹ç®¡ç†</h2>
            
            <!-- CSVæ©Ÿèƒ½ -->
            <div class="task-form">
                <h3 style="margin-bottom: 15px;">ğŸ“¤ CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                <div class="form-row">
                    <button class="btn" onclick="exportTasksCSV()">ğŸ“¥ CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <div class="form-group">
                        <label for="csvFile">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                        <input type="file" id="csvFile" accept=".csv" onchange="handleCSVFile(event)">
                    </div>
                </div>
                <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                    CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: name, base_points, description
                </p>
            </div>
            
            <div class="task-form">
                <h3 style="margin-bottom: 15px;">â• æ–°ã—ã„å®¶äº‹ã‚’è¿½åŠ </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newTaskName">å®¶äº‹å</label>
                        <input type="text" id="newTaskName" placeholder="ä¾‹: ãŠé¢¨å‘‚æƒé™¤">
                    </div>
                    <div class="form-group">
                        <label for="newTaskPoints">ãƒã‚¤ãƒ³ãƒˆ</label>
                        <input type="number" id="newTaskPoints" min="1" max="100" placeholder="ä¾‹: 15">
                    </div>
                </div>
                <div class="form-group">
                    <label for="newTaskDescription">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" id="newTaskDescription" placeholder="ä¾‹: æµ´æ§½ã¨ã‚¿ã‚¤ãƒ«ã®æƒé™¤">
                </div>
                <button class="btn" onclick="addNewTask()">â• å®¶äº‹ã‚’è¿½åŠ </button>
            </div>
        </div>

        <!-- å±¥æ­´ -->
        <div id="history" class="content hidden">
            <h2 style="margin-bottom: 20px;">ğŸ“ˆ å®¶äº‹å±¥æ­´</h2>
            <div id="historyList">
                <!-- å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
            </div>
            <button class="btn" onclick="loadHistory()">ğŸ”„ å±¥æ­´ã‚’æ›´æ–°</button>
        </div>
    </div>

    <div id="notification" class="notification">
        ãƒ†ã‚¹ãƒˆé€šçŸ¥
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentTab = 'dashboard';
        let isConnected = false;

        // APIæ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                statusText.textContent = 'APIæ¥ç¶šæ¸ˆã¿';
            } else {
                indicator.className = 'status-indicator disconnected';
                statusText.textContent = 'APIæ¥ç¶šã‚¨ãƒ©ãƒ¼';
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            // ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            document.getElementById(tabName).classList.remove('hidden');
            
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            event.target.classList.add('active');
            
            currentTab = tabName;

            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            switch(tabName) {
                case 'dashboard':
                    loadScores();
                    break;
                case 'tasks':
                    loadTasks();
                    break;
                case 'log':
                    await loadTasksForSelect(); // å®¶äº‹è¨˜éŒ²ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã‚‚æ›´æ–°
                    break;
                case 'history':
                    loadHistory();
                    break;
            }
        }

        // APIé–¢æ•°ç¾¤
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(endpoint, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                updateConnectionStatus(true);
                return await response.json();
            } catch (error) {
                console.error('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
                updateConnectionStatus(false);
                throw error;
            }
        }

        // ã‚¹ã‚³ã‚¢èª­ã¿è¾¼ã¿
        async function loadScores() {
            try {
                const scores = await apiCall('/scores/weekly');
                document.getElementById('wifePoints').textContent = scores.wife_points;
                document.getElementById('husbandPoints').textContent = scores.husband_points;
            } catch (error) {
                showNotification('ã‚¹ã‚³ã‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¿ã‚¹ã‚¯ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadTasks() {
            try {
                const response = await apiCall('/tasks');
                window.allTasks = response.tasks || []; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
                displayTasks(window.allTasks);
            } catch (error) {
                showNotification('ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function displayTasks(tasks) {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';
            
            if (tasks && tasks.length > 0) {
                tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item';
                    taskItem.setAttribute('data-task-id', task.id);
                    taskItem.innerHTML = `
                        <div class="task-header">
                            <div class="task-name">${task.name}</div>
                            <div class="task-points">${task.base_points}pt</div>
                        </div>
                        <div class="task-details">
                            èª¬æ˜: ${task.description}
                        </div>
                        <div class="task-actions">
                            <button class="btn-small" onclick="toggleEditForm(${task.id})">âœï¸ ç·¨é›†</button>
                            <button class="btn-small delete" onclick="deleteTask(${task.id}, '${task.name}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                        <div id="editForm${task.id}" class="edit-form hidden">
                            <div class="edit-form-row">
                                <input type="text" id="editName${task.id}" value="${task.name}" placeholder="å®¶äº‹å">
                                <input type="number" id="editPoints${task.id}" value="${task.base_points}" min="1" max="100" placeholder="ãƒã‚¤ãƒ³ãƒˆ">
                            </div>
                            <input type="text" id="editDescription${task.id}" value="${task.description}" placeholder="èª¬æ˜ï¼ˆä»»æ„ï¼‰">
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-small" onclick="saveTask(${task.id})">ğŸ’¾ ä¿å­˜</button>
                                <button class="btn-small" onclick="toggleEditForm(${task.id})">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            </div>
                        </div>
                    `;
                    tasksList.appendChild(taskItem);
                });
            } else {
                tasksList.innerHTML = '<p style="text-align: center; color: #666;">å®¶äº‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            }
        }

        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
        function filterTasks() {
            const searchTerm = document.getElementById('taskSearchBox').value.toLowerCase();
            const allTasks = window.allTasks || [];
            
            if (searchTerm === '') {
                displayTasks(allTasks);
            } else {
                const filteredTasks = allTasks.filter(task => 
                    task.name.toLowerCase().includes(searchTerm) || 
                    task.description.toLowerCase().includes(searchTerm)
                );
                displayTasks(filteredTasks);
            }
        }

        // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleEditForm(taskId) {
            const editForm = document.getElementById(`editForm${taskId}`);
            editForm.classList.toggle('hidden');
        }

        // ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜
        async function saveTask(taskId) {
            const name = document.getElementById(`editName${taskId}`).value.trim();
            const points = parseInt(document.getElementById(`editPoints${taskId}`).value);
            const description = document.getElementById(`editDescription${taskId}`).value.trim();

            if (!name || !points) {
                showNotification('å®¶äº‹åã¨ãƒã‚¤ãƒ³ãƒˆã¯å¿…é ˆã§ã™', 'error');
                return;
            }

            try {
                const updatedTask = {
                    name: name,
                    base_points: points,
                    description: description
                };

                await apiCall(`/tasks/${taskId}`, 'PUT', updatedTask);
                showNotification('å®¶äº‹ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');

                // ä¸€è¦§ã‚’æ›´æ–°
                loadTasks();
                // ã‚¿ã‚¹ã‚¯é¸æŠè‚¢ã‚‚æ›´æ–°
                loadTasksForSelect();

            } catch (error) {
                showNotification('å®¶äº‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
        async function deleteTask(taskId, taskName) {
            if (!confirm(`ã€Œ${taskName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                await apiCall(`/tasks/${taskId}`, 'DELETE');
                showNotification(`ã€Œ${taskName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);

                // ä¸€è¦§ã‚’æ›´æ–°
                loadTasks();
                // ã‚¿ã‚¹ã‚¯é¸æŠè‚¢ã‚‚æ›´æ–°
                loadTasksForSelect();

            } catch (error) {
                showNotification('å®¶äº‹ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // å®¶äº‹è¨˜éŒ²ç”¨ã®ã‚¿ã‚¹ã‚¯é¸æŠè‚¢ã‚’èª­ã¿è¾¼ã¿
        async function loadTasksForSelect() {
            try {
                const response = await apiCall('/tasks');
                const taskSelect = document.getElementById('taskSelect');
                taskSelect.innerHTML = '';
                
                if (response.tasks && response.tasks.length > 0) {
                    response.tasks.forEach(task => {
                        const option = document.createElement('option');
                        option.value = task.id;
                        option.textContent = `${task.name} (${task.base_points}pt)`;
                        taskSelect.appendChild(option);
                    });
                } else {
                    taskSelect.innerHTML = '<option value="">å®¶äº‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</option>';
                }
            } catch (error) {
                showNotification('ã‚¿ã‚¹ã‚¯é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // æ–°ã—ã„å®¶äº‹ã‚’è¿½åŠ 
        async function addNewTask() {
            const name = document.getElementById('newTaskName').value.trim();
            const points = parseInt(document.getElementById('newTaskPoints').value);
            const description = document.getElementById('newTaskDescription').value.trim();

            if (!name || !points) {
                showNotification('å®¶äº‹åã¨ãƒã‚¤ãƒ³ãƒˆã¯å¿…é ˆã§ã™', 'error');
                return;
            }

            try {
                const newTask = {
                    name: name,
                    base_points: points,
                    description: description
                };

                await apiCall('/tasks', 'POST', newTask);
                showNotification('æ–°ã—ã„å®¶äº‹ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('newTaskName').value = '';
                document.getElementById('newTaskPoints').value = '';
                document.getElementById('newTaskDescription').value = '';

                // å…¨ã¦ã®é–¢é€£ã™ã‚‹è¡¨ç¤ºã‚’æ›´æ–°
                await loadTasks();              // å®¶äº‹ä¸€è¦§ã‚’æ›´æ–°
                await loadTasksForSelect();     // å®¶äº‹è¨˜éŒ²ã®é¸æŠè‚¢ã‚’æ›´æ–°

            } catch (error) {
                showNotification('å®¶äº‹ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // å®¶äº‹è¨˜éŒ²
        async function logTask() {
            const button = document.getElementById('logButton');
            const originalText = button.innerHTML;
            
            try {
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                button.disabled = true;
                button.innerHTML = 'è¨˜éŒ²ä¸­...';
                
                const logData = {
                    task_id: parseInt(document.getElementById('taskSelect').value),
                    user_id: document.getElementById('userSelect').value,
                    load: parseFloat(document.getElementById('workLoad').value),
                    health: parseFloat(document.getElementById('healthCondition').value)
                };
                
                const result = await apiCall('/logs', 'POST', logData);
                
                showNotification(`${result.log.task_name} ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼+${result.log.points}pt`);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('workLoad').value = '1.0';
                document.getElementById('healthCondition').value = '1.0';
                
                // ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
                loadScores();
                
            } catch (error) {
                showNotification('å®¶äº‹ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // å±¥æ­´èª­ã¿è¾¼ã¿
        async function loadHistory() {
            try {
                const response = await apiCall('/logs');
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                if (response.logs && response.logs.length > 0) {
                    response.logs.forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry';
                        
                        const date = new Date(log.created_at);
                        const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                        const userIcon = log.user_id === 'wife' ? 'ğŸ‘© å¦»' : 'ğŸ‘¨ å¤«';
                        
                        logEntry.innerHTML = `
                            <div class="log-date">${dateStr}</div>
                            <div class="log-task">${log.task_name} (+${log.points}pt)</div>
                            <div class="log-user">å®Ÿè¡Œè€…: ${userIcon} (å‹¤å‹™è² è·: ${log.load}, ä½“èª¿: ${log.health})</div>
                        `;
                        historyList.appendChild(logEntry);
                    });
                } else {
                    historyList.innerHTML = '<p style="text-align: center; color: #666;">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                }
            } catch (error) {
                showNotification('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function exportTasksCSV() {
            try {
                const response = await fetch('/tasks/export');
                if (!response.ok) {
                    throw new Error('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'housework_tasks.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
            } catch (error) {
                showNotification('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function handleCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                const response = await fetch('/tasks/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/octet-stream',
                    },
                    body: arrayBuffer
                });

                const result = await response.json();

                if (result.error) {
                    showNotification(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${result.error}`, 'error');
                } else {
                    let message = result.message;
                    if (result.errors && result.errors.length > 0) {
                        message += `\nè­¦å‘Š: ${result.errors.length}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã—ãŸ`;
                        console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼è©³ç´°:', result.errors);
                    }
                    showNotification(message);

                    // å…¨ã¦ã®é–¢é€£ã™ã‚‹è¡¨ç¤ºã‚’æ›´æ–°
                    await loadTasks();              // å®¶äº‹ä¸€è¦§ã‚’æ›´æ–°
                    await loadTasksForSelect();     // å®¶äº‹è¨˜éŒ²ã®é¸æŠè‚¢ã‚’æ›´æ–°
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢
                event.target.value = '';

            } catch (error) {
                showNotification('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadScores();
            loadTasksForSelect();
        });
    </script>
</body>
</html>
